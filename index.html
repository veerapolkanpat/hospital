<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โรงพยาบาล วีระพลการแพทย์ - ดูแลสุขภาพของคุณด้วยใจ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f8fafc; /* Slate-50 */
        }
        .hero-background {
            background-image: url('https://placehold.co/1920x600/60a5fa/ffffff?text=ภาพโรงพยาบาลทันสมัย'); /* Placeholder image */
            background-size: cover;
            background-position: center;
            position: relative;
        }
        .hero-background::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.6) 100%);
        }
        /* Smooth scroll for anchor links */
        html {
            scroll-behavior: smooth;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8; /* Slate-400 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* Slate-500 */
        }
        /* Simple loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            width: 500px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white shadow-md fixed w-full z-50">
        <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
            <a href="#" class="flex items-center space-x-2">
                <img src="https://placehold.co/40x40/3b82f6/ffffff?text=โลโก้" alt="โลโก้โรงพยาบาล" class="rounded-full">
                <span class="text-2xl font-bold text-blue-600">โรงพยาบาล วีระพลการแพทย์</span>
            </a>
            <div class="hidden md:flex space-x-6">
                <a href="#hero" class="text-gray-600 hover:text-blue-600 font-medium transition duration-200">หน้าแรก</a>
                <a href="#about" class="text-gray-600 hover:text-blue-600 font-medium transition duration-200">เกี่ยวกับเรา</a>
                <a href="#services" class="text-gray-600 hover:text-blue-600 font-medium transition duration-200">บริการ</a>
                <a href="#doctors" class="text-gray-600 hover:text-blue-600 font-medium transition duration-200">แพทย์ของเรา</a>
                <a href="https://veerapolkanpat.github.io/appointment-form/" class="text-gray-600 hover:text-blue-600 font-medium transition duration-200" target="_blank">นัดหมาย</a>
                <a href="#health-qa" class="text-gray-600 hover:text-blue-600 font-medium transition duration-200">ปรึกษา AI</a>
                <a href="#contact" class="text-gray-600 hover:text-blue-600 font-medium transition duration-200">ติดต่อเรา</a>
                <button id="admin-button" class="text-gray-600 hover:text-blue-600 font-medium transition duration-200">
                    <i class="fas fa-user-shield mr-1"></i> Admin
                </button>
            </div>
            <button id="mobile-menu-button" class="md:hidden p-2 rounded-md text-gray-500 hover:text-blue-600 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </nav>
        <div id="mobile-menu" class="hidden md:hidden bg-white shadow-lg py-2">
            <a href="#hero" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 transition duration-200">หน้าแรก</a>
            <a href="#about" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 transition duration-200">เกี่ยวกับเรา</a>
            <a href="#services" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 transition duration-200">บริการ</a>
            <a href="#doctors" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 transition duration-200">แพทย์ของเรา</a>
            <a href="https://veerapolkanpat.github.io/appointment-form/" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 transition duration-200" target="_blank">นัดหมาย</a>
            <a href="#health-qa" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 transition duration-200">ปรึกษา AI</a>
            <a href="#contact" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 transition duration-200">ติดต่อเรา</a>
            <button id="mobile-admin-button" class="block w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100 transition duration-200">
                <i class="fas fa-user-shield mr-1"></i> Admin
            </button>
        </div>
    </header>

    <section id="hero" class="hero-background h-screen flex items-center justify-center text-white text-center pt-16">
        <div class="relative z-10 bg-black bg-opacity-60 p-8 md:p-12 rounded-lg max-w-3xl mx-auto shadow-2xl">
            <h1 class="text-4xl md:text-5xl font-extrabold leading-tight mb-4 animate-fade-in-up">
                ดูแลสุขภาพของคุณด้วยใจ ที่โรงพยาบาล วีระพลการแพทย์
            </h1>
            <p class="text-lg md:text-xl mb-8 opacity-90 animate-fade-in-up delay-200">
                บริการทางการแพทย์ครบวงจร ด้วยทีมแพทย์ผู้เชี่ยวชาญและเทคโนโลยีที่ทันสมัย
            </p>
            <a href="https://veerapolkanpat.github.io/appointment-form/" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 animate-fade-in-up delay-400" target="_blank">
                นัดหมายแพทย์วันนี้ <i class="fas fa-calendar-alt ml-2"></i>
            </a>
        </div>
    </section>

    ---

    <section id="about" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl md:text-4xl font-bold text-center text-blue-700 mb-12">เกี่ยวกับเรา</h2>
            <div class="flex flex-col md:flex-row items-center md:space-x-8">
                <div class="md:w-1/2 mb-8 md:mb-0">
                    <img src="https://placehold.co/600x400/a78bfa/ffffff?text=ภาพภายในโรงพยาบาล" alt="ภาพภายในโรงพยาบาล" class="rounded-lg shadow-xl w-full h-auto transform hover:scale-102 transition duration-300">
                </div>
                <div class="md:w-1/2">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">โรงพยาบาล วีระพลการแพทย์</h3>
                    <p class="text-gray-600 leading-relaxed mb-4">
                        โรงพยาบาลวีระพลการแพทย์ ก่อตั้งขึ้นด้วยความมุ่งมั่นที่จะเป็นศูนย์กลางการดูแลสุขภาพที่ครบวงจรในภูมิภาค ด้วยจำนวน 50 เตียง เราพร้อมให้บริการทางการแพทย์ที่ได้มาตรฐานสากล โดยทีมแพทย์ผู้เชี่ยวชาญ พยาบาล และบุคลากรทางการแพทย์ที่เปี่ยมด้วยประสบการณ์และความเอาใจใส่
                    </p>
                    <p class="text-gray-600 leading-relaxed">
                        เราให้ความสำคัญกับการนำเทคโนโลยีทางการแพทย์ที่ทันสมัยมาใช้ เพื่อให้การวินิจฉัยและการรักษาเป็นไปอย่างแม่นยำและมีประสิทธิภาพสูงสุด พร้อมสิ่งอำนวยความสะดวกที่ครบครัน เพื่อให้ผู้ป่วยและญาติได้รับความสะดวกสบายตลอดการเข้าใช้บริการ
                    </p>
                    <a href="#" class="mt-6 inline-block text-blue-600 hover:text-blue-800 font-semibold transition duration-200">อ่านเพิ่มเติม <i class="fas fa-arrow-right ml-1"></i></a>
                </div>
            </div>
        </div>
    </section>

    ---

    <section id="services" class="py-16 bg-blue-50">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl md:text-4xl font-bold text-center text-blue-700 mb-12">บริการของเรา</h2>
            <div id="services-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-lg flex flex-col items-center text-center justify-center min-h-[180px]">
                    <i class="fas fa-spinner fa-spin text-blue-500 text-3xl mb-4"></i>
                    <p class="text-gray-600">กำลังโหลดบริการ...</p>
                </div>
            </div>
        </div>
    </section>

    ---

    <section id="doctors" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl md:text-4xl font-bold text-center text-blue-700 mb-12">แพทย์ของเรา</h2>
            <div id="doctors-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="bg-blue-50 p-6 rounded-lg shadow-lg flex flex-col items-center text-center justify-center min-h-[250px]">
                    <i class="fas fa-spinner fa-spin text-blue-500 text-3xl mb-4"></i>
                    <p class="text-gray-600">กำลังโหลดข้อมูลแพทย์...</p>
                </div>
            </div>
            <div class="text-center mt-12">
                <a href="#" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                    ดูรายชื่อแพทย์ทั้งหมด <i class="fas fa-user-md ml-2"></i>
                </a>
            </div>
        </div>
    </section>

    ---

    <section id="appointment" class="py-16 bg-blue-600 text-white">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-3xl md:text-4xl font-bold mb-6">นัดหมายแพทย์</h2>
            <p class="text-lg md:text-xl mb-8">
                เพื่อความสะดวกสบายของคุณ สามารถนัดหมายแพทย์ล่วงหน้าได้ง่ายๆ ผ่านระบบออนไลน์ของเรา
            </p>
            <a href="https://veerapolkanpat.github.io/appointment-form/" class="bg-white text-blue-600 hover:bg-blue-100 font-bold py-4 px-10 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 inline-flex items-center justify-center text-lg" target="_blank">
                ไปที่หน้าจองนัดหมาย <i class="fas fa-external-link-alt ml-3"></i>
            </a>
            <p class="text-white text-sm mt-4 opacity-90">
                (คุณจะถูกนำไปยังหน้าฟอร์มการนัดหมายภายนอก)
            </p>
        </div>
    </section>

    ---

    <section id="health-qa" class="py-16 bg-blue-50">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-3xl md:text-4xl font-bold text-blue-700 mb-6">ปรึกษาปัญหาสุขภาพเบื้องต้น ✨</h2>
            <p class="text-lg md:text-xl text-gray-600 mb-8">
                สอบถามอาการหรือข้อสงสัยด้านสุขภาพเบื้องต้นกับ AI ของเรา
            </p>
            <div class="bg-white p-8 rounded-lg shadow-xl max-w-2xl mx-auto text-gray-800">
                <div class="mb-4">
                    <textarea id="health-question" rows="5" placeholder="พิมพ์คำถามเกี่ยวกับสุขภาพหรืออาการของคุณที่นี่ เช่น 'อาการปวดหัวแบบไหนที่ควรรีบไปพบแพทย์?'" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <button id="ask-ai-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 w-full flex items-center justify-center">
                    <span id="button-text">ถาม AI</span>
                    <div id="loading-spinner" class="spinner ml-3 hidden"></div>
                </button>
                <div id="ai-response" class="mt-8 p-6 bg-gray-50 border border-gray-200 rounded-lg text-left hidden">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">คำตอบจาก AI:</h3>
                    <p class="text-gray-700 whitespace-pre-wrap" id="response-content"></p>
                    <p class="text-red-500 text-sm mt-4">
                        <strong class="font-bold">ข้อควรทราบ:</strong> ข้อมูลนี้เป็นเพียงคำแนะนำเบื้องต้นจาก AI และไม่สามารถใช้ทดแทนการวินิจฉัยหรือคำแนะนำจากแพทย์ผู้เชี่ยวชาญได้ หากมีอาการผิดปกติ ควรปรึกษาแพทย์เพื่อการวินิจฉัยและการรักษาที่ถูกต้อง
                    </p>
                </div>
            </div>
        </div>
    </section>

    ---

    <section id="contact" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl md:text-4xl font-bold text-center text-blue-700 mb-12">ติดต่อเรา</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                <div class="bg-blue-50 p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">ข้อมูลการติดต่อ</h3>
                    <p class="text-gray-600 mb-2">
                        <strong class="text-blue-600">ที่อยู่:</strong> 12 หมู่ 15 ถนนวิจารณ์รังสรรค์ ตำบลหนองบัว อำเภอเมืองหนองบัวลำภู จังหวัดหนองบัวลำภู 39000
                    </p>
                    <p class="text-gray-600 mb-2">
                        <strong class="text-blue-600">โทรศัพท์:</strong> (042)312-344, (042)312-345, (042)-312-346
                    </p>
                    <p class="text-gray-600 mb-2">
                        <strong class="text-blue-600">โทรสาร:</strong> [เบอร์โทรสาร (ถ้ามี)]
                    </p>
                    <p class="text-gray-600 mb-2">
                        <strong class="text-blue-600">อีเมล:</strong> [อีเมลโรงพยาบาล]
                    </p>
                    <div class="mt-4 flex space-x-4">
                        <a href="https://www.facebook.com/Veerapolkanpat" target="_blank" class="text-blue-600 hover:text-blue-800 text-2xl" aria-label="Facebook">
                            <i class="fab fa-facebook-square"></i>
                        </a>
                        <a href="#" class="text-blue-600 hover:text-blue-800 text-2xl" aria-label="Line Official Account">
                            <i class="fab fa-line"></i>
                        </a>
                        </div>
                </div>
                <div class="bg-blue-50 p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">แผนที่</h3>
                    <iframe
                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3809.111867169429!2d102.40422137497184!3d17.202359283733074!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x31245df7b036c641%3A0x74a0058e578c7849!2z4Lih4Lir4Liy4Lio4Lij4Li14Lii4Liy4LiB4Liy4Lio4LiX4Liy4Lii4Liy4LiH4LmA4LiB4Lij4Liw4LmA4Liq4Liy4Lin4Lih4Liy4Lij4LmA4Lih4Lio4Liy4Lij4Lix4Lij4LiU4Lih4Liy!5e0!3m2!1sth!2sth!4v1700000000000!5m2!1sth!2sth"
                        width="100%"
                        height="300"
                        style="border:0;"
                        allowfullscreen=""
                        loading="lazy"
                        referrerpolicy="no-referrer-when-downgrade"
                        class="rounded-md"
                    ></iframe>
                </div>
            </div>
        </div>
    </section>

    ---

    <footer class="bg-gray-800 text-white py-8">
        <div class="container mx-auto px-4 text-center">
            <p>© 2025 โรงพยาบาล วีระพลการแพทย์ สงวนลิขสิทธิ์</p>
            <div class="flex justify-center space-x-4 mt-4">
                <a href="#" class="text-gray-400 hover:text-white transition duration-200">นโยบายความเป็นส่วนตัว</a>
                <span class="text-gray-400">|</span>
                <a href="#" class="text-gray-400 hover:text-white transition duration-200">ข้อกำหนดและเงื่อนไข</a>
            </div>
        </div>
    </footer>

    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-admin-modal">×</span>
            <h2 class="text-2xl font-bold text-blue-700 mb-6 text-center">จัดการข้อมูลโรงพยาบาล</h2>

            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">จัดการแพทย์</h3>
                <form id="doctor-form" class="space-y-4">
                    <input type="hidden" id="doctor-id">
                    <div>
                        <label for="doctor-name" class="block text-sm font-medium text-gray-700">ชื่อแพทย์</label>
                        <input type="text" id="doctor-name" placeholder="ชื่อ-นามสกุลแพทย์" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="doctor-specialty" class="block text-sm font-medium text-gray-700">สาขาเชี่ยวชาญ</label>
                        <input type="text" id="doctor-specialty" placeholder="เช่น อายุรแพทย์, ศัลยแพทย์" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="doctor-experience" class="block text-sm font-medium text-gray-700">ประสบการณ์</label>
                        <textarea id="doctor-experience" rows="2" placeholder="เช่น เชี่ยวชาญด้านโรคระบบทางเดินหายใจ ประสบการณ์ 15 ปี" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <div>
                        <label for="doctor-image" class="block text-sm font-medium text-gray-700">URL รูปภาพแพทย์ (Placeholder)</label>
                        <input type="text" id="doctor-image" placeholder="เช่น https://placehold.co/150x150/60a5fa/ffffff?text=แพทย์" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md w-full transition duration-200">
                        <span id="doctor-form-button-text">เพิ่มแพทย์</span>
                    </button>
                </form>
                <div class="mt-6">
                    <h4 class="text-lg font-semibold mb-3">รายชื่อแพทย์ที่มีอยู่ (คลิกเพื่อแก้ไข)</h4>
                    <ul id="doctors-list" class="space-y-2 max-h-60 overflow-y-auto border border-gray-200 p-3 rounded-md">
                        </ul>
                </div>
            </div>

            <div>
                <h3 class="text-xl font-semibold text-gray-800 mb-4">จัดการบริการ</h3>
                <form id="service-form" class="space-y-4">
                    <input type="hidden" id="service-id">
                    <div>
                        <label for="service-name" class="block text-sm font-medium text-gray-700">ชื่อบริการ/แผนก</label>
                        <input type="text" id="service-name" placeholder="เช่น แผนกอายุรกรรม" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label for="service-description" class="block text-sm font-medium text-gray-700">รายละเอียดบริการ</label>
                        <textarea id="service-description" rows="2" placeholder="เช่น ดูแลรักษาโรคทั่วไปและโรคเรื้อรังต่างๆ" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <div>
                        <label for="service-icon" class="block text-sm font-medium text-gray-700">คลาสไอคอน (Font Awesome)</label>
                        <input type="text" id="service-icon" placeholder="เช่น fas fa-heartbeat (ดู Font Awesome Icons)" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md w-full transition duration-200">
                        <span id="service-form-button-text">เพิ่มบริการ</span>
                    </button>
                </form>
                <div class="mt-6">
                    <h4 class="text-lg font-semibold mb-3">รายชื่อบริการที่มีอยู่ (คลิกเพื่อแก้ไข)</h4>
                    <ul id="services-list" class="space-y-2 max-h-60 overflow-y-auto border border-gray-200 p-3 rounded-md">
                        </ul>
                </div>
            </div>
            <p class="text-center text-sm text-gray-500 mt-8">
                User ID: <span id="current-user-id"></span>
            </p>
        </div>
    </div>

    <div id="message-modal" class="modal">
        <div class="modal-content text-center">
            <span class="close-button" id="close-message-modal">×</span>
            <h3 id="message-modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="message-modal-content" class="mb-6"></p>
            <button id="message-modal-ok-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md transition duration-200">ตกลง</button>
            <button id="message-modal-cancel-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-md ml-4 hidden transition duration-200">ยกเลิก</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, setDoc, doc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId;
        let isAuthReady = false;

        // --- Utility Functions for Modals (Replacing alert/confirm) ---
        function showMessageModal(title, message, type = 'alert', onConfirm = null) {
            const modal = document.getElementById('message-modal');
            const modalTitle = document.getElementById('message-modal-title');
            const modalContent = document.getElementById('message-modal-content');
            const okButton = document.getElementById('message-modal-ok-button');
            const cancelButton = document.getElementById('message-modal-cancel-button');

            modalTitle.textContent = title;
            modalContent.textContent = message;

            okButton.onclick = () => {
                modal.style.display = 'none';
                if (type === 'confirm' && onConfirm) {
                    onConfirm(true);
                }
            };

            if (type === 'confirm') {
                cancelButton.style.display = 'inline-block';
                cancelButton.onclick = () => {
                    modal.style.display = 'none';
                    if (onConfirm) {
                        onConfirm(false);
                    }
                };
            } else {
                cancelButton.style.display = 'none';
            }

            modal.style.display = 'flex'; // Use flex to center
        }

        // --- Firebase Initialization and Authentication ---
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is empty. Cannot initialize Firebase.");
                    showMessageModal("ข้อผิดพลาด", "ไม่สามารถเชื่อมต่อ Firebase ได้: การตั้งค่าไม่ถูกต้อง", "alert");
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('current-user-id').textContent = userId;
                        console.log("User signed in:", userId);
                    } else {
                        // Sign in anonymously if no token, or if token failed
                        if (initialAuthToken) {
                            try {
                                const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                                userId = userCredential.user.uid;
                                document.getElementById('current-user-id').textContent = userId;
                                console.log("Signed in with custom token:", userId);
                            } catch (error) {
                                console.error("Error signing in with custom token:", error);
                                showMessageModal("ข้อผิดพลาด", "ไม่สามารถเข้าสู่ระบบได้: " + error.message, "alert");
                                await signInAnonymously(auth); // Fallback to anonymous
                                userId = auth.currentUser?.uid || crypto.randomUUID();
                                document.getElementById('current-user-id').textContent = userId;
                                console.log("Signed in anonymously after token failure:", userId);
                            }
                        } else {
                            await signInAnonymously(auth);
                            userId = auth.currentUser?.uid || crypto.randomUUID();
                            document.getElementById('current-user-id').textContent = userId;
                            console.log("Signed in anonymously:", userId);
                        }
                    }
                    isAuthReady = true;
                    // Once auth is ready, start loading data
                    loadDoctors();
                    loadServices();
                    // populateAppointmentDoctors(); // This line is no longer needed as the form is external
                    loadAdminDoctors();
                    loadAdminServices();
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessageModal("ข้อผิดพลาด", "ไม่สามารถเริ่มต้น Firebase ได้: " + error.message, "alert");
            }
        }

        // --- Firestore Data Loading and Rendering (Public Facing) ---

        // Function to render services on the main page
        function renderServices(services) {
            const container = document.getElementById('services-container');
            container.innerHTML = ''; // Clear existing content
            if (services.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center text-gray-500">ยังไม่มีข้อมูลบริการ</p>';
                return;
            }
            services.forEach(service => {
                const serviceCard = `
                    <div class="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition duration-300 ease-in-out transform hover:-translate-y-1">
                        <div class="text-blue-500 text-4xl mb-4 text-center">
                            <i class="${service.icon || 'fas fa-hospital'} mx-auto"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2 text-center">${service.name}</h3>
                        <p class="text-gray-600 text-center">
                            ${service.description}
                        </p>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', serviceCard);
            });
        }

        // Function to render doctors on the main page
        function renderDoctors(doctors) {
            const container = document.getElementById('doctors-container');
            container.innerHTML = ''; // Clear existing content
            if (doctors.length === 0) {
                container.innerHTML = '<p class="col-span-full text-center text-gray-500">ยังไม่มีข้อมูลแพทย์</p>';
                return;
            }
            doctors.forEach(doctor => {
                const doctorCard = `
                    <div class="bg-blue-50 p-6 rounded-lg shadow-lg flex flex-col items-center text-center">
                        <img src="${doctor.image || 'https://placehold.co/150x150/60a5fa/ffffff?text=แพทย์'}" alt="${doctor.name}" class="w-24 h-24 rounded-full object-cover mb-4 shadow-md">
                        <h3 class="text-xl font-semibold text-gray-800 mb-1">${doctor.name}</h3>
                        <p class="text-blue-600 font-medium mb-2">${doctor.specialty}</p>
                        <p class="text-gray-600 text-sm">${doctor.experience}</p>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', doctorCard);
            });
        }

        // --- Data Loading from Firestore ---
        async function loadServices() {
            if (!isAuthReady) {
                console.warn("Firebase Auth not ready, skipping loadServices.");
                return;
            }
            try {
                const servicesCol = collection(db, 'services');
                const serviceSnapshot = await getDocs(servicesCol);
                const servicesList = serviceSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderServices(servicesList);
            } catch (error) {
                console.error("Error loading services: ", error);
                showMessageModal("ข้อผิดพลาด", "ไม่สามารถโหลดข้อมูลบริการได้: " + error.message, "alert");
                document.getElementById('services-container').innerHTML = '<p class="col-span-full text-center text-red-500">เกิดข้อผิดพลาดในการโหลดบริการ</p>';
            }
        }

        async function loadDoctors() {
            if (!isAuthReady) {
                console.warn("Firebase Auth not ready, skipping loadDoctors.");
                return;
            }
            try {
                const doctorsCol = collection(db, 'doctors');
                const doctorSnapshot = await getDocs(doctorsCol);
                const doctorsList = doctorSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderDoctors(doctorsList);
            } catch (error) {
                console.error("Error loading doctors: ", error);
                showMessageModal("ข้อผิดพลาด", "ไม่สามารถโหลดข้อมูลแพทย์ได้: " + error.message, "alert");
                document.getElementById('doctors-container').innerHTML = '<p class="col-span-full text-center text-red-500">เกิดข้อผิดพลาดในการโหลดข้อมูลแพทย์</p>';
            }
        }

        // --- Admin Panel Functions ---

        const adminModal = document.getElementById('admin-modal');
        const adminButton = document.getElementById('admin-button');
        const closeAdminModal = document.getElementById('close-admin-modal');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileAdminButton = document.getElementById('mobile-admin-button');

        adminButton.onclick = () => {
            adminModal.style.display = 'flex';
        }

        mobileAdminButton.onclick = () => {
            adminModal.style.display = 'flex';
            mobileMenu.classList.add('hidden'); // Hide mobile menu when admin modal opens
        }

        closeAdminModal.onclick = () => {
            adminModal.style.display = 'none';
            // Clear forms and reset buttons when closing
            document.getElementById('doctor-form').reset();
            document.getElementById('doctor-id').value = '';
            document.getElementById('doctor-form-button-text').textContent = 'เพิ่มแพทย์';
            document.getElementById('service-form').reset();
            document.getElementById('service-id').value = '';
            document.getElementById('service-form-button-text').textContent = 'เพิ่มบริการ';
        }

        window.onclick = (event) => {
            if (event.target == adminModal) {
                adminModal.style.display = 'none';
                // Clear forms and reset buttons when closing
                document.getElementById('doctor-form').reset();
                document.getElementById('doctor-id').value = '';
                document.getElementById('doctor-form-button-text').textContent = 'เพิ่มแพทย์';
                document.getElementById('service-form').reset();
                document.getElementById('service-id').value = '';
                document.getElementById('service-form-button-text').textContent = 'เพิ่มบริการ';
            }
            if (event.target == document.getElementById('message-modal')) {
                document.getElementById('message-modal').style.display = 'none';
            }
        }

        mobileMenuButton.onclick = () => {
            mobileMenu.classList.toggle('hidden');
        };

        // Close mobile menu when a link is clicked
        document.querySelectorAll('#mobile-menu a').forEach(item => {
            item.addEventListener('click', () => {
                mobileMenu.classList.add('hidden');
            });
        });

        // Close message modal
        document.getElementById('close-message-modal').onclick = () => {
            document.getElementById('message-modal').style.display = 'none';
        };


        // --- Admin Doctor Management ---
        const doctorForm = document.getElementById('doctor-form');
        const doctorsListAdmin = document.getElementById('doctors-list');
        const doctorIdField = document.getElementById('doctor-id');
        const doctorNameField = document.getElementById('doctor-name');
        const doctorSpecialtyField = document.getElementById('doctor-specialty');
        const doctorExperienceField = document.getElementById('doctor-experience');
        const doctorImageField = document.getElementById('doctor-image');
        const doctorFormButtonText = document.getElementById('doctor-form-button-text');

        // Load doctors for admin panel
        async function loadAdminDoctors() {
            if (!isAuthReady) return;
            const q = query(collection(db, 'doctors'));
            onSnapshot(q, (snapshot) => {
                doctorsListAdmin.innerHTML = '';
                snapshot.docs.forEach(docData => {
                    const doctor = { id: docData.id, ...docData.data() };
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-md shadow-sm hover:bg-gray-100 transition duration-150';
                    li.innerHTML = `
                        <span>${doctor.name} (${doctor.specialty})</span>
                        <div>
                            <button data-id="${doctor.id}" data-name="${doctor.name}" data-specialty="${doctor.specialty}" data-experience="${doctor.experience}" data-image="${doctor.image}" class="edit-doctor-btn text-blue-600 hover:text-blue-800 mr-2"><i class="fas fa-edit"></i></button>
                            <button data-id="${doctor.id}" class="delete-doctor-btn text-red-600 hover:text-red-800"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    doctorsListAdmin.appendChild(li);
                });
                addDoctorEventListeners();
            });
        }

        function addDoctorEventListeners() {
            doctorsListAdmin.querySelectorAll('.edit-doctor-btn').forEach(button => {
                button.onclick = (e) => {
                    const { id, name, specialty, experience, image } = e.currentTarget.dataset;
                    doctorIdField.value = id;
                    doctorNameField.value = name;
                    doctorSpecialtyField.value = specialty;
                    doctorExperienceField.value = experience;
                    doctorImageField.value = image;
                    doctorFormButtonText.textContent = 'อัปเดตแพทย์';
                };
            });

            doctorsListAdmin.querySelectorAll('.delete-doctor-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.currentTarget.dataset.id;
                    showMessageModal("ยืนยันการลบ", "คุณแน่ใจหรือไม่ว่าต้องการลบแพทย์ท่านนี้?", "confirm", (confirmed) => {
                        if (confirmed) {
                            deleteDoctor(id);
                        }
                    });
                };
            });
        }

        doctorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = doctorIdField.value;
            const name = doctorNameField.value.trim();
            const specialty = doctorSpecialtyField.value.trim();
            const experience = doctorExperienceField.value.trim();
            const image = doctorImageField.value.trim();

            if (!name || !specialty) {
                showMessageModal("ข้อมูลไม่ครบถ้วน", "กรุณากรอกชื่อแพทย์และสาขาเชี่ยวชาญ", "alert");
                return;
            }

            const doctorData = { name, specialty, experience, image };

            try {
                if (id) {
                    // Update existing doctor
                    await setDoc(doc(db, 'doctors', id), doctorData);
                    showMessageModal("สำเร็จ", "อัปเดตข้อมูลแพทย์เรียบร้อยแล้ว", "alert");
                } else {
                    // Add new doctor
                    await addDoc(collection(db, 'doctors'), doctorData);
                    showMessageModal("สำเร็จ", "เพิ่มแพทย์ใหม่เรียบร้อยแล้ว", "alert");
                }
                doctorForm.reset();
                doctorIdField.value = '';
                doctorFormButtonText.textContent = 'เพิ่มแพทย์';
                loadDoctors(); // Refresh public view
            } catch (e) {
                console.error("Error saving doctor: ", e);
                showMessageModal("ข้อผิดพลาด", "ไม่สามารถบันทึกข้อมูลแพทย์ได้: " + e.message, "alert");
            }
        });

        async function deleteDoctor(id) {
            try {
                await deleteDoc(doc(db, 'doctors', id));
                showMessageModal("สำเร็จ", "ลบแพทย์เรียบร้อยแล้ว", "alert");
                loadDoctors(); // Refresh public view
            } catch (e) {
                console.error("Error deleting doctor: ", e);
                showMessageModal("ข้อผิดพลาด", "ไม่สามารถลบแพทย์ได้: " + e.message, "alert");
            }
        }

        // --- Admin Service Management ---
        const serviceForm = document.getElementById('service-form');
        const servicesListAdmin = document.getElementById('services-list');
        const serviceIdField = document.getElementById('service-id');
        const serviceNameField = document.getElementById('service-name');
        const serviceDescriptionField = document.getElementById('service-description');
        const serviceIconField = document.getElementById('service-icon');
        const serviceFormButtonText = document.getElementById('service-form-button-text');

        // Load services for admin panel
        async function loadAdminServices() {
            if (!isAuthReady) return;
            const q = query(collection(db, 'services'));
            onSnapshot(q, (snapshot) => {
                servicesListAdmin.innerHTML = '';
                snapshot.docs.forEach(docData => {
                    const service = { id: docData.id, ...docData.data() };
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-md shadow-sm hover:bg-gray-100 transition duration-150';
                    li.innerHTML = `
                        <span><i class="${service.icon} mr-2"></i>${service.name}</span>
                        <div>
                            <button data-id="${service.id}" data-name="${service.name}" data-description="${service.description}" data-icon="${service.icon}" class="edit-service-btn text-blue-600 hover:text-blue-800 mr-2"><i class="fas fa-edit"></i></button>
                            <button data-id="${service.id}" class="delete-service-btn text-red-600 hover:text-red-800"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    servicesListAdmin.appendChild(li);
                });
                addServiceEventListeners();
            });
        }

        function addServiceEventListeners() {
            servicesListAdmin.querySelectorAll('.edit-service-btn').forEach(button => {
                button.onclick = (e) => {
                    const { id, name, description, icon } = e.currentTarget.dataset;
                    serviceIdField.value = id;
                    serviceNameField.value = name;
                    serviceDescriptionField.value = description;
                    serviceIconField.value = icon;
                    serviceFormButtonText.textContent = 'อัปเดตบริการ';
                };
            });

            servicesListAdmin.querySelectorAll('.delete-service-btn').forEach(button => {
                button.onclick = (e) => {
                    const id = e.currentTarget.dataset.id;
                    showMessageModal("ยืนยันการลบ", "คุณแน่ใจหรือไม่ว่าต้องการลบบริการนี้?", "confirm", (confirmed) => {
                        if (confirmed) {
                            deleteService(id);
                        }
                    });
                };
            });
        }

        serviceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = serviceIdField.value;
            const name = serviceNameField.value.trim();
            const description = serviceDescriptionField.value.trim();
            const icon = serviceIconField.value.trim();

            if (!name) {
                showMessageModal("ข้อมูลไม่ครบถ้วน", "กรุณากรอกชื่อบริการ/แผนก", "alert");
                return;
            }

            const serviceData = { name, description, icon };

            try {
                if (id) {
                    // Update existing service
                    await setDoc(doc(db, 'services', id), serviceData);
                    showMessageModal("สำเร็จ", "อัปเดตข้อมูลบริการเรียบร้อยแล้ว", "alert");
                } else {
                    // Add new service
                    await addDoc(collection(db, 'services'), serviceData);
                    showMessageModal("สำเร็จ", "เพิ่มบริการใหม่เรียบร้อยแล้ว", "alert");
                }
                serviceForm.reset();
                serviceIdField.value = '';
                serviceFormButtonText.textContent = 'เพิ่มบริการ';
                loadServices(); // Refresh public view
            } catch (e) {
                console.error("Error saving service: ", e);
                showMessageModal("ข้อผิดพลาด", "ไม่สามารถบันทึกข้อมูลบริการได้: " + e.message, "alert");
            }
        });

        async function deleteService(id) {
            try {
                await deleteDoc(doc(db, 'services', id));
                showMessageModal("สำเร็จ", "ลบบริการเรียบร้อยแล้ว", "alert");
                loadServices(); // Refresh public view
            } catch (e) {
                console.error("Error deleting service: ", e);
                showMessageModal("ข้อผิดพลาด", "ไม่สามารถลบบริการได้: " + e.message, "alert");
            }
        }

        // --- Gemini AI Integration ---
        const askAiButton = document.getElementById('ask-ai-button');
        const healthQuestionInput = document.getElementById('health-question');
        const aiResponseDiv = document.getElementById('ai-response');
        const responseContent = document.getElementById('response-content');
        const loadingSpinner = document.getElementById('loading-spinner');
        const buttonText = document.getElementById('button-text');

        askAiButton.addEventListener('click', async () => {
            const question = healthQuestionInput.value.trim();
            if (!question) {
                showMessageModal("กรุณาป้อนคำถาม", "คุณต้องพิมพ์คำถามเกี่ยวกับสุขภาพของคุณก่อน", "alert");
                return;
            }

            // Show loading spinner
            buttonText.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            askAiButton.disabled = true;
            aiResponseDiv.classList.add('hidden');
            responseContent.textContent = '';

            try {
                const apiUrl = `/__run__/ask_gemini?prompt=${encodeURIComponent(question)}`;
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                responseContent.textContent = data.response;
                aiResponseDiv.classList.remove('hidden');
            } catch (error) {
                console.error("Error asking AI: ", error);
                responseContent.textContent = "ขออภัย เกิดข้อผิดพลาดในการประมวลผลคำถามของคุณ กรุณาลองใหม่อีกครั้ง";
                aiResponseDiv.classList.remove('hidden');
                showMessageModal("ข้อผิดพลาด", "ไม่สามารถเชื่อมต่อ AI ได้: " + error.message, "alert");
            } finally {
                // Hide loading spinner
                buttonText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
                askAiButton.disabled = false;
            }
        });

        // Initialize Firebase when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>
